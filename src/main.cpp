#include <cerrno>
#include <fstream>
#include <iomanip>

#include "include/Contour.hpp"
#include "include/GFileRawData.hpp"
#include "include/Spdata.hpp"

#define ZQ_TIMER_IMPLEMENTATION
#include "include/Timer.h"

#ifndef M_PI
#define M_PI 3.14159265358979323846
#endif

int main(int argc, char** argv) {
    auto& timer = Timer::get_timer();
    timer.start("Read g-file");

    if (argc == 1) {
        std::cerr << "Please provide gfile path.\n";
        return ENOENT;
    }

    std::string filename{argv[1]};
    std::ifstream g_file(filename);
    if (!g_file.is_open()) {
        std::cerr << "Can not open g-file.\n";
        return ENOENT;
    }

    GFileRawData g_file_data;
    g_file >> g_file_data;
    if (!g_file_data.is_complete()) { return EPERM; }
    g_file.close();

    timer.pause_last_and_start_next("Generate BSpline");

    constexpr std::size_t RADIAL_GRID_COUNT = 129;
    constexpr std::size_t POLOIDAL_GRID_COUNT = 255;

    Spdata spdata(g_file_data, RADIAL_GRID_COUNT, POLOIDAL_GRID_COUNT);

    timer.pause_last_and_start_next("Write to spdata ");

    std::string output_path{};
    if (argc == 2) {
        output_path = filename;
        output_path.resize(output_path.find_last_of('/'));
    } else {
        output_path = argv[2];
    }
    std::ofstream output(output_path + "/spdata.dat", std::ios::out);
    output << "Generated by MCT, from " << filename << '\n';
    output << spdata;

    timer.pause();
    timer.print();

    return 0;
}
